mode: daemonset

# Підключення до shared-network для доступу до docker-compose сервісів
hostNetwork: true
dnsPolicy: ClusterFirstWithHostNet

service:
  enabled: true
  type: ClusterIP

image:
  repository: otel/opentelemetry-collector-contrib
  # tag автоматично береться з appVersion Helm chart (0.134.1 для chart 0.133.0)
  pullPolicy: IfNotPresent

# Resource limits для dev середовища
resources:
  limits:
    cpu: 200m
    memory: 256Mi
  requests:
    cpu: 100m
    memory: 128Mi

# Вимкнути preset, бо використовуємо власну конфігурацію k8sattributes
presets:
  kubernetesAttributes:
    enabled: false

config:
  receivers:
    otlp:
      protocols:
        grpc: {}
        http: {}

  processors:
    # Захист від OOM - має бути першим у pipeline
    memory_limiter:
      check_interval: 1s
      limit_mib: 200
      spike_limit_mib: 50

    k8sattributes:
      extract:
        metadata:
          - k8s.namespace.name
          - k8s.pod.name
          - k8s.deployment.name
          # k8s.container.name не потрібен - у нас single-container pods
        labels:
          - key: app.kubernetes.io/name
            tag_name: service.name
          - key: app.kubernetes.io/version
            tag_name: service.version
          - key: app.kubernetes.io/environment
            tag_name: deployment.environment
      passthrough: true  # Не відкидати телеметрію якщо pod не знайдено (для dev)
      pod_association:
        - sources:
            - from: resource_attribute
              name: k8s.pod.ip
        - sources:
            - from: resource_attribute
              name: k8s.pod.uid
        - sources:
            - from: connection
        - sources:
            - from: resource_attribute
              name: k8s.pod.name
            - from: resource_attribute
              name: k8s.namespace.name

    # Копіювання deployment name в service.name якщо не встановлено
    resource:
      attributes:
        - key: service.name
          from_attribute: k8s.deployment.name
          action: insert

    resource/cleanup:
      attributes:
        # Видаляємо тимчасові k8s атрибути, залишаючи тільки service.name та namespace
        - action: delete
          key: k8s.deployment.name
        - action: delete
          key: k8s.pod.uid
        - action: delete
          key: k8s.pod.start_time
        - action: delete
          key: k8s.node.name

    batch:
      send_batch_size: 1024
      timeout: 10s
      send_batch_max_size: 2048

  exporters:
    # ТРЕЙСИ → Tempo в docker-compose (через shared-network)
    otlp/tempo:
      endpoint: tempo:4317
      tls:
        insecure: true
      retry_on_failure:
        enabled: true
        initial_interval: 1s
        max_interval: 30s
        max_elapsed_time: 300s
    
    # МЕТРИКИ → Prometheus в docker-compose (через remote write receiver)
    otlphttp/metrics:
      endpoint: http://prometheus:9090/api/v1/otlp
      tls:
        insecure: true
      retry_on_failure:
        enabled: true
        initial_interval: 1s
        max_interval: 30s
        max_elapsed_time: 300s
    
    # Debug exporter для troubleshooting (вимкнено в prod)
    debug:
      verbosity: detailed
      sampling_initial: 5
      sampling_thereafter: 200

  service:
    pipelines:
      traces:
        receivers:  [otlp]
        processors: [memory_limiter, k8sattributes, resource, resource/cleanup, batch]
        exporters:  [otlp/tempo, debug]
      metrics:
        receivers:  [otlp]
        processors: [memory_limiter, k8sattributes, resource, resource/cleanup, batch]
        exporters:  [otlphttp/metrics, debug]
