name: API Release

on:
  workflow_call:
    secrets:
      NPM_TOKEN:
        required: true

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup tools
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.6'
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Cache Go tools
        id: cache-go-tools
        uses: actions/cache@v4
        with:
          path: ~/go/bin
          key: go-tools-${{ runner.os }}-week-${{ github.run_id }}
          restore-keys: |
            go-tools-${{ runner.os }}-week-

      - name: Cache npm global packages
        id: cache-npm-global
        uses: actions/cache@v4
        with:
          path: ~/.npm-global
          key: npm-global-${{ runner.os }}-week-${{ github.run_id }}
          restore-keys: |
            npm-global-${{ runner.os }}-week-

      - name: Configure npm global directory
        run: |
          mkdir -p ~/.npm-global
          npm config set prefix '~/.npm-global'
          echo "~/.npm-global/bin" >> $GITHUB_PATH

      - name: Install generators
        run: |
          # Always install latest versions (cache serves as fallback for faster builds)
          go install github.com/ogen-go/ogen/cmd/ogen@latest
          go install github.com/daveshanley/vacuum@latest
          go install github.com/Sokol111/ecommerce-commons/cmd/eventgen@latest
          npm install -g orval

      # ============================================
      # EXTRACT VERSION & VALIDATE
      # ============================================
      - name: Extract version
        id: version
        run: |
          VERSION=$(yq e '.info.version' openapi/openapi.yml)
          echo "version=v$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Version: v$VERSION"

      - name: Check if tag exists
        run: |
          if git rev-parse "refs/tags/${{ steps.version.outputs.version }}" >/dev/null 2>&1; then
            echo "‚ùå Tag ${{ steps.version.outputs.version }} already exists"
            exit 1
          fi

      # ============================================
      # GENERATE ALL CODE
      # ============================================
      - name: Generate Go API
        run: make openapi-generate

      - name: Generate TypeScript client
        run: |
          make openapi-ts-generate \
            TS_VERSION="${{ steps.version.outputs.version }}" \
            TS_PACKAGE_NAME="@${GITHUB_REPOSITORY,,}"

      - name: Generate Events (Avro)
        if: hashFiles('avro/*.avsc') != ''
        run: make events-generate

      - name: Finalize Go module
        run: go mod tidy

      # ============================================
      # PUBLISH NPM PACKAGE
      # ============================================
      - name: Publish to NPM
        working-directory: gen/typescript
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      # ============================================
      # CREATE RELEASE
      # ============================================
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create release branch and tag
        run: |
          # Cleanup source files (keep only generated)
          rm -rf openapi avro
          
          # Remove TypeScript (already published to npm)
          rm -rf gen/typescript
          
          # Create orphan release branch
          git checkout --orphan release
          git rm -rf --cached .
          
          # Add only generated code + go.mod
          git add -f gen/ go.mod go.sum
          git commit -m "Release ${{ steps.version.outputs.version }}"
          
          # Tag and push
          git tag "${{ steps.version.outputs.version }}"
          git push origin "${{ steps.version.outputs.version }}" --force
          git push origin release --force

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          generate_release_notes: true
