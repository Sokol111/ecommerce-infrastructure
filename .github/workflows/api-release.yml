name: API Release Pipeline

on:
  workflow_call:
    secrets:
      NPM_TOKEN:
        required: true
      SCHEMA_REGISTRY_URL:
        required: false
        description: URL of the Schema Registry for publishing Avro schemas

permissions:
  contents: write

jobs:
  # ============================================
  # PREPARE: Determine versions and settings
  # ============================================
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.ver.outputs.version }}
      npm_repo_name: ${{ steps.repo.outputs.npm_repo_name }}
      project_name: ${{ steps.proj.outputs.project_name }}
      has_asyncapi: ${{ steps.check-asyncapi.outputs.has_asyncapi }}

    steps:
      - uses: actions/checkout@v4

      - id: check-asyncapi
        run: |
          if [ -f "asyncapi/asyncapi.yaml" ]; then
            echo "âœ“ AsyncAPI file found"
            echo "has_asyncapi=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸  AsyncAPI file not found"
            echo "has_asyncapi=false" >> $GITHUB_OUTPUT
          fi

      - id: ver
        run: |
          openapi_version=$(yq e '.info.version' openapi/openapi.yml)
          
          # Check if asyncapi exists and compare versions
          if [ -f "asyncapi/asyncapi.yaml" ]; then
            asyncapi_version=$(yq e '.info.version' asyncapi/asyncapi.yaml)
            if [ "$openapi_version" != "$asyncapi_version" ]; then
              echo "âŒ Version mismatch!"
              echo "  OpenAPI version:    $openapi_version"
              echo "  AsyncAPI version:   $asyncapi_version"
              echo ""
              echo "Please sync versions in both files:"
              echo "  - openapi/openapi.yml: info.version"
              echo "  - asyncapi/asyncapi.yaml: info.version"
              exit 1
            fi
            echo "âœ“ Versions match: $openapi_version"
          fi
          
          echo "version=v$openapi_version" >> $GITHUB_OUTPUT

      - id: repo
        run: |
          echo "npm_repo_name=@${GITHUB_REPOSITORY,,}" >> $GITHUB_OUTPUT

      - id: proj
        run: |
          echo "project_name=$(basename ${GITHUB_REPOSITORY})" >> $GITHUB_OUTPUT

      - name: Summary
        run: |
          echo "### ðŸ“¦ Release Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | \`${{ steps.ver.outputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| NPM Package | \`${{ steps.repo.outputs.npm_repo_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Project | \`${{ steps.proj.outputs.project_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Has AsyncAPI | ${{ steps.check-asyncapi.outputs.has_asyncapi }} |" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # OPENAPI PIPELINE: Build Go + JS API
  # ============================================
  openapi-pipeline:
    needs: prepare
    uses: Sokol111/ecommerce-infrastructure/.github/workflows/openapi-pipeline.yml@master
    with:
      version: ${{ needs.prepare.outputs.version }}
      npm_repo_name: ${{ needs.prepare.outputs.npm_repo_name }}
      project_name: ${{ needs.prepare.outputs.project_name }}

  # ============================================
  # ASYNCAPI PIPELINE: Build Events + Publish Schemas
  # ============================================
  asyncapi-pipeline:
    needs: prepare
    if: needs.prepare.outputs.has_asyncapi == 'true'
    uses: Sokol111/ecommerce-infrastructure/.github/workflows/asyncapi-pipeline.yml@master
    secrets:
      SCHEMA_REGISTRY_URL: ${{ secrets.SCHEMA_REGISTRY_URL }}

  # ============================================
  # FINALIZE GO MODULE: Run go mod tidy after all code generation
  # ============================================
  finalize-go-module:
    needs: [prepare, openapi-pipeline, asyncapi-pipeline]
    if: always() && needs.prepare.result == 'success' && needs.openapi-pipeline.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.5'

      - name: Download Go API artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.openapi-pipeline.outputs.go_artifact }}
          path: ${{ needs.openapi-pipeline.outputs.go_artifact_dir }}

      - name: Download Events artifact
        if: needs.asyncapi-pipeline.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.asyncapi-pipeline.outputs.events_artifact }}
          path: ${{ needs.asyncapi-pipeline.outputs.events_artifact_dir }}

      - name: Run go mod tidy
        run: |
          echo "ðŸ“¦ Running go mod tidy..."
          go mod tidy
          echo "âœ“ go.mod and go.sum updated"
          echo ""
          echo "go.mod contents:"
          cat go.mod

      - name: Upload go.mod artifact
        uses: actions/upload-artifact@v4
        with:
          name: go-module
          path: |
            go.mod
            go.sum

  # ============================================
  # PREPARE RELEASE ARTIFACTS: Build artifact list dynamically
  # ============================================
  prepare-release-artifacts:
    needs: [prepare, openapi-pipeline, asyncapi-pipeline, finalize-go-module]
    if: always() && needs.prepare.result == 'success' && needs.openapi-pipeline.result == 'success' && needs.finalize-go-module.result == 'success'
    runs-on: ubuntu-latest
    outputs:
      artifacts: ${{ steps.build-list.outputs.artifacts }}
      artifact_dirs: ${{ steps.build-list.outputs.artifact_dirs }}
    steps:
      - id: build-list
        run: |
          # Start with go-module artifact (go.mod, go.sum go to root)
          artifacts="go-module,${{ needs.openapi-pipeline.outputs.go_artifact }}"
          artifact_dirs=".,${{ needs.openapi-pipeline.outputs.go_artifact_dir }}"
          
          if [ "${{ needs.asyncapi-pipeline.result }}" == "success" ] && [ -n "${{ needs.asyncapi-pipeline.outputs.events_artifact }}" ]; then
            artifacts="${artifacts},${{ needs.asyncapi-pipeline.outputs.events_artifact }}"
            artifact_dirs="${artifact_dirs},${{ needs.asyncapi-pipeline.outputs.events_artifact_dir }}"
            echo "âœ“ Including AsyncAPI artifact: ${{ needs.asyncapi-pipeline.outputs.events_artifact }}"
          fi
          
          echo "artifacts=${artifacts}" >> $GITHUB_OUTPUT
          echo "artifact_dirs=${artifact_dirs}" >> $GITHUB_OUTPUT
          echo "### ðŸ“¦ Artifacts for Release" >> $GITHUB_STEP_SUMMARY
          echo "Artifacts: \`${artifacts}\`" >> $GITHUB_STEP_SUMMARY
          echo "Directories: \`${artifact_dirs}\`" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # RELEASE: Create Git tag and GitHub Release
  # ============================================
  create-release:
    needs: [prepare, openapi-pipeline, asyncapi-pipeline, finalize-go-module, prepare-release-artifacts]
    if: always() && needs.prepare.result == 'success' && needs.openapi-pipeline.result == 'success' && needs.finalize-go-module.result == 'success'
    uses: Sokol111/ecommerce-infrastructure/.github/workflows/release-tag.yml@master
    with:
      version: ${{ needs.prepare.outputs.version }}
      artifacts: ${{ needs.prepare-release-artifacts.outputs.artifacts }}
      artifact_dirs: ${{ needs.prepare-release-artifacts.outputs.artifact_dirs }}
      cleanup_dirs: 'asyncapi,openapi,avro'

  # ============================================
  # PUBLISH: Publish JS client to NPM
  # ============================================
  publish-npm:
    needs: [openapi-pipeline, create-release]
    if: always() && needs.openapi-pipeline.result == 'success' && needs.create-release.result == 'success'
    uses: Sokol111/ecommerce-infrastructure/.github/workflows/publish-js.yml@master
    secrets:
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
    with:
      artifact_dir: ${{ needs.openapi-pipeline.outputs.js_artifact_dir }}
      artifact: ${{ needs.openapi-pipeline.outputs.js_artifact }}
