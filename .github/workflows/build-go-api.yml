name: Build Go API

on:
  workflow_call:
    inputs:
      openapi_file:
        required: false
        type: string
        default: 'openapi/openapi.yml'
      artifact:
        required: true
        type: string
      artifact_dir:
        required: false
        type: string
        default: 'gen/httpapi'
      package:
        required: false
        type: string
        default: 'httpapi'

permissions:
  contents: write

jobs:
  build-go:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.25.5

      - name: Install ogen
        run: go install github.com/ogen-go/ogen/cmd/ogen@latest

      - name: Create output directory
        run: mkdir -p ${{ inputs.artifact_dir }}

      - name: Generate Go code with ogen
        run: |
          echo "Generating Go code with ogen..."
          ogen -target ${{ inputs.artifact_dir }} -package ${{ inputs.package }} -clean ${{ inputs.openapi_file }}

      - name: Embed OpenAPI spec
        run: |
          echo "Copying OpenAPI spec to ${{ inputs.artifact_dir }}/openapi.yml"
          cp ${{ inputs.openapi_file }} ${{ inputs.artifact_dir }}/openapi.yml
          echo "Generating Go embedded openapi_embed.gen.go..."
          echo "package ${{ inputs.package }}" > ${{ inputs.artifact_dir }}/openapi_embed.gen.go
          echo "" >> ${{ inputs.artifact_dir }}/openapi_embed.gen.go
          echo "import _ \"embed\"" >> ${{ inputs.artifact_dir }}/openapi_embed.gen.go
          echo "" >> ${{ inputs.artifact_dir }}/openapi_embed.gen.go
          echo "//go:embed openapi.yml" >> ${{ inputs.artifact_dir }}/openapi_embed.gen.go
          echo "var OpenAPIDoc []byte" >> ${{ inputs.artifact_dir }}/openapi_embed.gen.go

      - name: Upload built Go API
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact }}
          path: ${{ inputs.artifact_dir }}
