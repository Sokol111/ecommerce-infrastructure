name: Build Go API

on:
  workflow_call:
    inputs:
      openapi_file:
        required: true
        type: string
      artifact:
        required: true
        type: string
      artifact_dir:
        required: true
        type: string
      package:
        required: true
        type: string

permissions:
  contents: write

jobs:
  build-go:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.24.2

      - name: Init Go module
        run: go mod init github.com/${{ github.repository }}

      - name: Install oapi-codegen
        run: go install github.com/oapi-codegen/oapi-codegen/v2/cmd/oapi-codegen@latest

      - name: Create output directory
        run: mkdir -p ${{ inputs.artifact_dir }}

      - name: Generate Go types (models)
        run: |
          echo "Generating Go types (models)..."
          $HOME/go/bin/oapi-codegen -generate types -package ${{ inputs.package }} -o ${{ inputs.artifact_dir }}/models.gen.go ${{ inputs.openapi_file }}

      - name: Generate Go server
        run: |
          echo "Generating Go server..."
          $HOME/go/bin/oapi-codegen -generate gin-server,strict-server,spec -package ${{ inputs.package }} -o ${{ inputs.artifact_dir }}/server.gen.go ${{ inputs.openapi_file }}

      - name: Generate Go client
        run: |
          echo "Generating Go client..."
          $HOME/go/bin/oapi-codegen -generate client -package ${{ inputs.package }} -o ${{ inputs.artifact_dir }}/client.gen.go ${{ inputs.openapi_file }}

      - name: Embed OpenAPI spec
        run: |
          echo "Copying OpenAPI spec to ${{ inputs.artifact_dir }}/openapi.yml"
          cp ${{ inputs.openapi_file }} ${{ inputs.artifact_dir }}/openapi.yml
          echo "Generating Go embedded openapi.gen.go..."
          echo "package ${{ inputs.package }}" > ${{ inputs.artifact_dir }}/openapi.gen.go
          echo "" >> ${{ inputs.artifact_dir }}/openapi.gen.go
          echo "import _ \"embed\"" >> ${{ inputs.artifact_dir }}/openapi.gen.go
          echo "" >> ${{ inputs.artifact_dir }}/openapi.gen.go
          echo "//go:embed openapi.yml" >> ${{ inputs.artifact_dir }}/openapi.gen.go
          echo "var OpenAPIDoc []byte" >> ${{ inputs.artifact_dir }}/openapi.gen.go

      - name: Upload built Go API
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact }}
          path: ${{ inputs.artifact_dir }}
